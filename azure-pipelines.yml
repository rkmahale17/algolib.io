# Trigger only on pushes to main (after merge)
trigger:
  branches:
    include:
      - main

pr: none

pool:
  vmImage: "ubuntu-latest"

# Variables
variables:
  - group: AlgoLib-Secrets  # Variable group from Library containing all secrets
  - name: nodeVersion
    value: "22"
  - name: projectId
    value: "algolib"
  - name: region
    value: "us-west1"
  - name: imageName
    value: "algo-image"
  - name: qaService
    value: "qaalgo"
  - name: prodService
    value: "prodalgolib"

stages:
  # =========================
  # QA STAGE (no approval)
  # =========================
  - stage: QA
    displayName: "Build & Deploy to QA"
    jobs:
      - job: BuildAndDeployQA
        displayName: "Build image and deploy to QA"
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: $(nodeVersion)
            displayName: "Install Node.js"

          - script: |
              npm ci
              npm run build
            displayName: "Build app"

          - task: DownloadSecureFile@1
            name: gcpKey
            inputs:
              secureFile: "algolib.json"

          - script: |
              set -e
              sudo apt-get update -y
              sudo apt-get install -y apt-transport-https ca-certificates gnupg
              echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee /etc/apt/sources.list.d/google-cloud-sdk.list
              curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg
              sudo apt-get update -y && sudo apt-get install -y google-cloud-sdk
            displayName: "Install Google Cloud SDK"

          - script: |
              gcloud auth activate-service-account --key-file="$(gcpKey.secureFilePath)"
              gcloud config set project $(projectId)
              gcloud config set run/region $(region)
            displayName: "Authenticate to Google Cloud"

          # Build with build args for environment variables
          - script: |
              gcloud builds submit \
                --tag gcr.io/$(projectId)/$(imageName):$(Build.BuildId) \
                --substitutions=_VITE_SUPABASE_URL=$(VITE_SUPABASE_URL),_VITE_SUPABASE_PUBLISHABLE_KEY=$(VITE_SUPABASE_PUBLISHABLE_KEY),_VITE_SUPABASE_PROJECT_ID=$(VITE_SUPABASE_PROJECT_ID),_JUDGE0_API_KEY=$(JUDGE0_API_KEY),_JUDGE0_API_HOST=$(JUDGE0_API_HOST),_JUDGE0_API_URL=$(JUDGE0_API_URL)
            displayName: "Cloud Build -> GCR with env vars"

          # Deploy to QA service
          - script: |
              gcloud run deploy $(qaService) \
                --image gcr.io/$(projectId)/$(imageName):$(Build.BuildId) \
                --platform managed \
                --region $(region) \
                --allow-unauthenticated \
                --memory 512Mi \
                --cpu 1 \
                --min-instances 0 \
                --max-instances 1 \
                --set-env-vars "APP_ENV=qa,VITE_SUPABASE_URL=$(VITE_SUPABASE_URL),VITE_SUPABASE_PUBLISHABLE_KEY=$(VITE_SUPABASE_PUBLISHABLE_KEY),VITE_SUPABASE_PROJECT_ID=$(VITE_SUPABASE_PROJECT_ID),JUDGE0_API_KEY=$(JUDGE0_API_KEY),JUDGE0_API_HOST=$(JUDGE0_API_HOST),JUDGE0_API_URL=$(JUDGE0_API_URL)"
            displayName: "Deploy to Cloud Run (QA)"

  # =========================
  # PROD STAGE (approval required)
  # =========================
  - stage: PROD
    displayName: "Deploy to PROD"
    dependsOn: QA
    condition: succeeded()
    jobs:
      - deployment: DeployToProd
        displayName: "Deploy approved image to PROD"
        environment: "Production"
        strategy:
          runOnce:
            deploy:
              steps:
                - task: DownloadSecureFile@1
                  name: gcpKey
                  inputs:
                    secureFile: "algolib.json"

                - script: |
                    set -e
                    sudo apt-get update -y
                    sudo apt-get install -y apt-transport-https ca-certificates gnupg
                    echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee /etc/apt/sources.list.d/google-cloud-sdk.list
                    curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg
                    sudo apt-get update -y && sudo apt-get install -y google-cloud-sdk
                  displayName: "Install Google Cloud SDK"

                - script: |
                    gcloud auth activate-service-account --key-file="$(gcpKey.secureFilePath)"
                    gcloud config set project $(projectId)
                    gcloud config set run/region $(region)
                  displayName: "Authenticate to Google Cloud"

                - script: |
                    gcloud run deploy $(prodService) \
                      --image gcr.io/$(projectId)/$(imageName):$(Build.BuildId) \
                      --platform managed \
                      --region $(region) \
                      --allow-unauthenticated \
                      --memory 512Mi \
                      --cpu 1 \
                      --min-instances 0 \
                      --max-instances 1 \
                      --set-env-vars "APP_ENV=prod,VITE_SUPABASE_URL=$(VITE_SUPABASE_URL),VITE_SUPABASE_PUBLISHABLE_KEY=$(VITE_SUPABASE_PUBLISHABLE_KEY),VITE_SUPABASE_PROJECT_ID=$(VITE_SUPABASE_PROJECT_ID),JUDGE0_API_KEY=$(JUDGE0_API_KEY),JUDGE0_API_HOST=$(JUDGE0_API_HOST),JUDGE0_API_URL=$(JUDGE0_API_URL)"
                  displayName: "Deploy to Cloud Run (PROD)"